<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spark - å¥½å‹é‚€è«‹</title>
  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
      min-height: 100vh;
      /* æ–°å“ç‰Œè‰²ï¼šè—è‰²æ¼¸å±¤ */
      background: linear-gradient(135deg, #1E88A8 0%, #2B7A98 50%, #3D6B88 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .card {
      background: white;
      border-radius: 24px;
      padding: 40px 30px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .logo {
      text-align: center;
      margin-bottom: 10px;
    }
    
    .logo-icon {
      font-size: 48px;
    }
    
    .title {
      text-align: center;
      font-size: 28px;
      font-weight: 700;
      color: #1F2937;
      margin-bottom: 5px;
    }
    
    .subtitle {
      text-align: center;
      font-size: 14px;
      color: #6B7280;
      margin-bottom: 25px;
    }
    
    .reward-box {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .reward-item {
      text-align: center;
    }
    
    .reward-label {
      font-size: 12px;
      color: #92400E;
      margin-bottom: 5px;
    }
    
    .reward-value {
      font-size: 36px;
      font-weight: 700;
      color: #D97706;
    }
    
    .reward-icon {
      font-size: 40px;
    }
    
    .code-box {
      background: #F3F4F6;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .code-label {
      font-size: 12px;
      color: #6B7280;
      margin-bottom: 5px;
    }
    
    .code-value {
      font-size: 24px;
      font-weight: 700;
      color: #1F2937;
      letter-spacing: 2px;
    }
    
    .join-btn {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 18px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 25px;
      transition: transform 0.2s, box-shadow 0.2s;
      text-decoration: none;
    }
    
    .join-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
    }
    
    .join-btn:active {
      transform: translateY(0);
    }
    
    .join-btn:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .join-btn.success {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    }
    
    .features {
      margin-bottom: 20px;
    }
    
    .feature-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      font-size: 14px;
      color: #374151;
    }
    
    .feature-icon {
      font-size: 20px;
    }
    
    .footer-text {
      text-align: center;
      font-size: 12px;
      color: #9CA3AF;
    }
    
    .footer-text span {
      color: #F59E0B;
      font-weight: 600;
    }
    
    /* ç‹€æ…‹è¨Šæ¯ */
    .status-message {
      text-align: center;
      font-size: 14px;
      color: #6B7280;
      margin-bottom: 15px;
      min-height: 20px;
    }
    
    .status-message.error {
      color: #EF4444;
    }
    
    .status-message.success {
      color: #10B981;
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- Logo -->
    <div class="logo">
      <span class="logo-icon">âœ¨</span>
    </div>
    
    <!-- æ¨™é¡Œ -->
    <h1 class="title">Spark éˆæ„Ÿå¯«æ‰‹</h1>
    <p class="subtitle">AI å¹«ä½ å¯«å‡ºå¸ç›ç¤¾ç¾¤æ–‡æ¡ˆ</p>
    
    <!-- çå‹µèªªæ˜ -->
    <div class="reward-box">
      <div class="reward-item">
        <div class="reward-label">ä½ ç²å¾—</div>
        <div class="reward-value">50</div>
      </div>
      <div class="reward-icon">ğŸ¤</div>
      <div class="reward-item">
        <div class="reward-label">æœ‹å‹ç²å¾—</div>
        <div class="reward-value">50</div>
      </div>
    </div>
    
    <!-- é‚€è«‹ç¢¼ -->
    <div class="code-box">
      <div class="code-label">æœ‹å‹çš„é‚€è«‹ç¢¼</div>
      <div class="code-value" id="referralCode">SPARK-XXXXXX</div>
    </div>
    
    <!-- ç‹€æ…‹è¨Šæ¯ -->
    <div class="status-message" id="statusMessage"></div>
    
    <!-- åŠ å…¥æŒ‰éˆ• -->
    <button class="join-btn" id="joinBtn" disabled>
      <span class="spinner"></span>
      è¼‰å…¥ä¸­...
    </button>
    
    <!-- åŠŸèƒ½èªªæ˜ -->
    <div class="features">
      <div class="feature-item">
        <span class="feature-icon">ğŸ“¸</span>
        <span>å‚³ç…§ç‰‡ï¼Œ30ç§’ç”Ÿæˆæ–‡æ¡ˆ</span>
      </div>
      <div class="feature-item">
        <span class="feature-icon">ğŸ¨</span>
        <span>å¤šç¨®é¢¨æ ¼ï¼Œç¬¦åˆä½ çš„å“ç‰Œ</span>
      </div>
      <div class="feature-item">
        <span class="feature-icon">ğŸ“±</span>
        <span>ä¸€éµç™¼å¸ƒåˆ° IG / FB</span>
      </div>
    </div>
    
    <!-- åº•éƒ¨èªªæ˜ -->
    <p class="footer-text">
      å®Œæˆ 3 ç¯‡æ–‡æ¡ˆå¾Œï¼Œé›™æ–¹éƒ½èƒ½ç²å¾— <span>50 é»</span>çå‹µï¼
    </p>
  </div>

  <script>
    // ============================================================
    // è¨­å®š
    // ============================================================
    const LIFF_ID = '2008053214-77W1AfvL';
    const LINE_OA_URL = 'https://lin.ee/sPuEW6B';
    const LINE_ADD_FRIEND_URL = 'https://line.me/R/ti/p/@010ndcrh';
    
    // ============================================================
    // å…¨åŸŸè®Šæ•¸
    // ============================================================
    let referralCode = 'SPARK-XXXXXX';
    let isLoggedIn = false;
    let isFriend = false;
    
    // ============================================================
    // DOM å…ƒç´ 
    // ============================================================
    const joinBtn = document.getElementById('joinBtn');
    const statusMessage = document.getElementById('statusMessage');
    const referralCodeEl = document.getElementById('referralCode');
    
    // ============================================================
    // å·¥å…·å‡½æ•¸
    // ============================================================
    function getRefCode() {
      const urlParams = new URLSearchParams(window.location.search);
      // æ”¯æ´å¤šç¨®åƒæ•¸åç¨±
      return urlParams.get('ref') || 
             urlParams.get('code') || 
             urlParams.get('referral_code') || 
             'SPARK-XXXXXX';
    }
    
    function setStatus(message, type = '') {
      statusMessage.textContent = message;
      statusMessage.className = 'status-message ' + type;
    }
    
    function setButtonState(text, icon = '', disabled = false, className = '') {
      joinBtn.innerHTML = icon ? `${icon} ${text}` : text;
      joinBtn.disabled = disabled;
      joinBtn.className = 'join-btn ' + className;
    }
    
    // ============================================================
    // ä¸»è¦é‚è¼¯
    // ============================================================
    async function initializeLiff() {
      try {
        // é¡¯ç¤ºæ¨è–¦ç¢¼
        referralCode = getRefCode();
        referralCodeEl.textContent = referralCode;
        
        // åˆå§‹åŒ– LIFF
        await liff.init({ liffId: LIFF_ID });
        console.log('LIFF initialized');
        
        // æª¢æŸ¥æ˜¯å¦åœ¨ LINE å…§
        if (!liff.isInClient()) {
          // ä¸åœ¨ LINE å…§ï¼Œé¡¯ç¤ºå¤–éƒ¨é€£çµ
          setStatus('è«‹åœ¨ LINE ä¸­é–‹å•Ÿæ­¤é€£çµ');
          setButtonState('åœ¨ LINE ä¸­é–‹å•Ÿ', 'ğŸ“±', false);
          joinBtn.onclick = () => {
            window.location.href = `https://liff.line.me/${LIFF_ID}?ref=${referralCode}`;
          };
          return;
        }
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        isLoggedIn = liff.isLoggedIn();
        if (!isLoggedIn) {
          setStatus('è«‹å…ˆç™»å…¥ LINE');
          setButtonState('ç™»å…¥ LINE', 'ğŸ”', false);
          joinBtn.onclick = () => liff.login();
          return;
        }
        
        // æª¢æŸ¥æ˜¯å¦å·²åŠ å…¥å¥½å‹
        const friendship = await liff.getFriendship();
        isFriend = friendship.friendFlag;
        
        if (isFriend) {
          // å·²ç¶“æ˜¯å¥½å‹ï¼Œç›´æ¥ç™¼é€æ¨è–¦ç¢¼
          setStatus('ä½ å·²ç¶“æ˜¯ Spark å¥½å‹ï¼');
          setButtonState('ğŸ é ˜å–æ¨è–¦çå‹µ', '', false);
          joinBtn.onclick = sendReferralCode;
        } else {
          // é‚„ä¸æ˜¯å¥½å‹ï¼Œé¡¯ç¤ºåŠ å…¥æŒ‰éˆ•
          setStatus('åŠ å…¥ Spark ç«‹å³ç²å¾—çå‹µï¼');
          setButtonState('ğŸš€ åŠ å…¥é ˜å–çå‹µ', '', false);
          joinBtn.onclick = addFriendAndBind;
        }
        
      } catch (error) {
        console.error('LIFF init error:', error);
        setStatus('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†', 'error');
        setButtonState('é‡æ–°æ•´ç†', 'ğŸ”„', false);
        joinBtn.onclick = () => window.location.reload();
      }
    }
    
    // ============================================================
    // åŠ å…¥å¥½å‹ä¸¦ç¶å®šæ¨è–¦ç¢¼
    // ============================================================
    async function addFriendAndBind() {
      setButtonState('è™•ç†ä¸­...', 'â³', true);
      
      try {
        // é–‹å•ŸåŠ å…¥å¥½å‹é é¢
        // ä½¿ç”¨ liff.openWindow åœ¨ LINE å…§é–‹å•Ÿ
        liff.openWindow({
          url: LINE_ADD_FRIEND_URL,
          external: false
        });
        
        // ç­‰å¾…ä¸€ä¸‹è®“ç”¨æˆ¶åŠ å…¥
        setStatus('åŠ å…¥å¥½å‹å¾Œï¼Œè«‹å›ä¾†é»æ“Šé ˜å–çå‹µ');
        
        // å»¶é²å¾Œé‡æ–°æª¢æŸ¥å¥½å‹ç‹€æ…‹
        setTimeout(async () => {
          try {
            const friendship = await liff.getFriendship();
            if (friendship.friendFlag) {
              // å·²åŠ å…¥ï¼Œç™¼é€æ¨è–¦ç¢¼
              isFriend = true;
              setStatus('å·²åŠ å…¥ï¼æ­£åœ¨é ˜å–çå‹µ...');
              await sendReferralCode();
            } else {
              // é‚„æ²’åŠ å…¥
              setStatus('åŠ å…¥å¥½å‹å¾Œå³å¯é ˜å–çå‹µ');
              setButtonState('ğŸ æˆ‘å·²åŠ å…¥ï¼Œé ˜å–çå‹µ', '', false);
              joinBtn.onclick = checkAndSend;
            }
          } catch (e) {
            console.error('Check friendship error:', e);
            setButtonState('ğŸ é ˜å–çå‹µ', '', false);
            joinBtn.onclick = checkAndSend;
          }
        }, 3000);
        
      } catch (error) {
        console.error('Add friend error:', error);
        setStatus('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦', 'error');
        setButtonState('ğŸš€ é‡è©¦', '', false);
        joinBtn.onclick = addFriendAndBind;
      }
    }
    
    // ============================================================
    // æª¢æŸ¥ä¸¦ç™¼é€æ¨è–¦ç¢¼
    // ============================================================
    async function checkAndSend() {
      setButtonState('æª¢æŸ¥ä¸­...', 'â³', true);
      
      try {
        const friendship = await liff.getFriendship();
        
        if (friendship.friendFlag) {
          await sendReferralCode();
        } else {
          setStatus('è«‹å…ˆåŠ å…¥ Spark å¥½å‹', 'error');
          setButtonState('ğŸš€ åŠ å…¥é ˜å–çå‹µ', '', false);
          joinBtn.onclick = addFriendAndBind;
        }
      } catch (error) {
        console.error('Check and send error:', error);
        setStatus('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦', 'error');
        setButtonState('ğŸ é‡è©¦', '', false);
        joinBtn.onclick = checkAndSend;
      }
    }
    
    // ============================================================
    // ç™¼é€æ¨è–¦ç¢¼çµ¦ Bot
    // ============================================================
    async function sendReferralCode() {
      setButtonState('é ˜å–ä¸­...', 'â³', true);
      
      try {
        // ç™¼é€æ¨è–¦ç¢¼è¨Šæ¯çµ¦ Bot
        await liff.sendMessages([
          {
            type: 'text',
            text: `æ¨è–¦ç¢¼ï¼š${referralCode}`
          }
        ]);
        
        // æˆåŠŸï¼
        setStatus('ğŸ‰ çå‹µé ˜å–æˆåŠŸï¼', 'success');
        setButtonState('âœ… å·²é ˜å–ï¼Œé–‹å§‹ä½¿ç”¨', '', false, 'success');
        
        // é»æ“Šå¾Œé—œé–‰ LIFF
        joinBtn.onclick = () => {
          liff.closeWindow();
        };
        
        // 3 ç§’å¾Œè‡ªå‹•é—œé–‰
        setTimeout(() => {
          liff.closeWindow();
        }, 3000);
        
      } catch (error) {
        console.error('Send message error:', error);
        
        // å¦‚æœç™¼é€è¨Šæ¯å¤±æ•—ï¼Œå¯èƒ½æ˜¯æ¬Šé™å•é¡Œ
        // æ”¹ç”¨å…¶ä»–æ–¹å¼
        if (error.code === 'FORBIDDEN') {
          setStatus('è«‹åœ¨èŠå¤©å®¤ä¸­è¼¸å…¥æ¨è–¦ç¢¼', 'error');
          setButtonState('ğŸ“‹ è¤‡è£½æ¨è–¦ç¢¼', '', false);
          joinBtn.onclick = () => {
            navigator.clipboard.writeText(referralCode).then(() => {
              setStatus('å·²è¤‡è£½ï¼è«‹è²¼åˆ°èŠå¤©å®¤', 'success');
              setTimeout(() => liff.closeWindow(), 2000);
            });
          };
        } else {
          setStatus('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æ¨è–¦ç¢¼', 'error');
          setButtonState('é—œé–‰', '', false);
          joinBtn.onclick = () => liff.closeWindow();
        }
      }
    }
    
    // ============================================================
    // å•Ÿå‹•
    // ============================================================
    document.addEventListener('DOMContentLoaded', initializeLiff);
  </script>
</body>
</html>
