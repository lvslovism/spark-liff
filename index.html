<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spark æ¨è–¦é€£çµ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #4A90C4 0%, #F5A623 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px 30px;
      max-width: 360px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .logo { font-size: 48px; margin-bottom: 20px; }
    .title { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 10px; }
    .subtitle { color: #666; margin-bottom: 30px; line-height: 1.6; }
    .status { padding: 20px; border-radius: 12px; margin-bottom: 20px; }
    .status.loading { background: #f0f0f0; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status-icon { font-size: 36px; margin-bottom: 10px; }
    .status-text { font-size: 16px; line-height: 1.5; }
    .referrer-name { font-weight: bold; color: #4A90C4; }
    .note { 
      font-size: 13px; 
      color: #888; 
      margin-top: 15px; 
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .btn {
      display: inline-block;
      padding: 14px 32px;
      border-radius: 30px;
      text-decoration: none;
      font-weight: bold;
      font-size: 16px;
      transition: transform 0.2s, box-shadow 0.2s;
      border: none;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
    .btn-primary { background: linear-gradient(135deg, #4A90C4 0%, #F5A623 100%); color: white; }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .countdown { font-size: 14px; color: #999; margin-top: 15px; }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4A90C4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none; }
    .debug { font-size: 10px; color: #ccc; margin-top: 20px; word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">âœ¨</div>
    <div class="title">Spark AI</div>
    <div class="subtitle">30 ç§’å¯«å¥½ç¤¾ç¾¤æ–‡æ¡ˆ<br>è®“ AI å¹«ä½ èªªå‡ºå¿ƒè£¡è©±</div>
    
    <div id="status" class="status loading">
      <div class="spinner"></div>
      <div class="status-text">æ­£åœ¨è™•ç†...</div>
    </div>
    
    <div id="actions"></div>
    <div id="note" class="note hidden"></div>
    <div id="countdown" class="countdown hidden"></div>
    <div id="debug" class="debug hidden"></div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ============================================
    // ğŸ”§ é…ç½®å€
    // ============================================
    const CONFIG = {
      LIFF_ID: '2008053214-77W1AfvL',
      PREBIND_API: 'https://astrapath.app.n8n.cloud/webhook/referral-prebind',
      LINE_ADD_FRIEND_URL: 'https://lin.ee/H4VqlLt',
      AUTO_REDIRECT_DELAY: 3000,
      DEBUG: false  // è¨­ç‚º true é¡¯ç¤ºé™¤éŒ¯è¨Šæ¯
    };

    // ============================================
    // DOM å…ƒç´ 
    // ============================================
    const statusEl = document.getElementById('status');
    const actionsEl = document.getElementById('actions');
    const noteEl = document.getElementById('note');
    const countdownEl = document.getElementById('countdown');
    const debugEl = document.getElementById('debug');

    // ============================================
    // å·¥å…·å‡½æ•¸
    // ============================================
    function setStatus(icon, text, type) {
      statusEl.className = `status ${type}`;
      statusEl.innerHTML = `
        <div class="status-icon">${icon}</div>
        <div class="status-text">${text}</div>
      `;
    }

    function setActions(buttons) {
      actionsEl.innerHTML = buttons.map(btn => 
        `<button class="btn ${btn.class}" onclick="${btn.action}">${btn.label}</button>`
      ).join('');
    }

    function setNote(text) {
      if (text) {
        noteEl.textContent = text;
        noteEl.classList.remove('hidden');
      } else {
        noteEl.classList.add('hidden');
      }
    }

    function setDebug(text) {
      if (CONFIG.DEBUG) {
        debugEl.textContent = text;
        debugEl.classList.remove('hidden');
      }
    }

    function startCountdown(seconds, callback) {
      countdownEl.classList.remove('hidden');
      let remaining = seconds;
      countdownEl.textContent = `${remaining} ç§’å¾Œè‡ªå‹•è·³è½‰...`;
      
      const timer = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          clearInterval(timer);
          callback();
        } else {
          countdownEl.textContent = `${remaining} ç§’å¾Œè‡ªå‹•è·³è½‰...`;
        }
      }, 1000);
    }

    // ============================================
    // ğŸ”‘ å–å¾—æ¨è–¦ç¢¼ï¼ˆæ”¯æ´å¤šç¨®æƒ…æ³ï¼‰
    // ============================================
    function getReferralCode() {
      // 1. å¾ URL search åƒæ•¸å–å¾—
      const urlParams = new URLSearchParams(window.location.search);
      let code = urlParams.get('ref');
      if (code) {
        console.log('å¾ search å–å¾— ref:', code);
        return code;
      }

      // 2. å¾ URL hash å–å¾—ï¼ˆLIFF æœ‰æ™‚æœƒé€™æ¨£è™•ç†ï¼‰
      if (window.location.hash) {
        // hash å¯èƒ½æ˜¯ #ref=XXX æˆ– #?ref=XXX
        let hashString = window.location.hash.substring(1);
        if (hashString.startsWith('?')) {
          hashString = hashString.substring(1);
        }
        const hashParams = new URLSearchParams(hashString);
        code = hashParams.get('ref');
        if (code) {
          console.log('å¾ hash å–å¾— ref:', code);
          return code;
        }
      }

      // 3. å¾ localStorage å–å¾—ï¼ˆä¹‹å‰ä¿å­˜çš„ï¼‰
      code = localStorage.getItem('spark_referral_code');
      if (code) {
        console.log('å¾ localStorage å–å¾— ref:', code);
        return code;
      }

      // 4. å¾å®Œæ•´ URL ç”¨æ­£å‰‡è¡¨é”å¼è§£æ
      const fullUrl = window.location.href;
      const match = fullUrl.match(/[?&#]ref=([A-Z0-9-]+)/i);
      if (match) {
        code = match[1];
        console.log('å¾å®Œæ•´ URL æ­£å‰‡å–å¾— ref:', code);
        return code;
      }

      console.log('æ‰¾ä¸åˆ° ref åƒæ•¸');
      return null;
    }

    // ============================================
    // éŒ¯èª¤è™•ç†
    // ============================================
    function handleError(errorCode, message) {
      const errorConfig = {
        'INVALID_LINE_USER_ID': {
          icon: 'âŒ', 
          text: 'ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡è¨Š',
          buttons: [{ label: 'é‡è©¦', class: 'btn-primary', action: 'location.reload()' }]
        },
        'INVALID_REFERRAL_CODE': {
          icon: 'âŒ', 
          text: 'æ¨è–¦ç¢¼æ ¼å¼ä¸æ­£ç¢º',
          buttons: [{ label: 'ç›´æ¥åŠ å…¥ Spark', class: 'btn-primary', action: `location.href='${CONFIG.LINE_ADD_FRIEND_URL}'` }]
        },
        'REFERRER_NOT_FOUND': {
          icon: 'âŒ', 
          text: 'æ‰¾ä¸åˆ°é€™å€‹æ¨è–¦ç¢¼',
          buttons: [{ label: 'ç›´æ¥åŠ å…¥ Spark', class: 'btn-primary', action: `location.href='${CONFIG.LINE_ADD_FRIEND_URL}'` }]
        },
        'SELF_REFERRAL': {
          icon: 'ğŸ™…', 
          text: 'ä¸èƒ½ä½¿ç”¨è‡ªå·±çš„æ¨è–¦ç¢¼å–”',
          buttons: [{ label: 'è¿”å›', class: 'btn-primary', action: 'liff.closeWindow()' }]
        },
        'ALREADY_HAS_REFERRER': {
          icon: 'âœ…', 
          text: 'ä½ å·²ç¶“ç¶å®šéæ¨è–¦ç¢¼å›‰ï¼',
          buttons: [{ label: 'é–‹å§‹ä½¿ç”¨ Spark', class: 'btn-primary', action: 'liff.closeWindow()' }]
        }
      };

      const config = errorConfig[errorCode] || {
        icon: 'âŒ',
        text: message || 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦',
        buttons: [
          { label: 'é‡è©¦', class: 'btn-secondary', action: 'location.reload()' },
          { label: 'ç›´æ¥åŠ å…¥', class: 'btn-primary', action: `location.href='${CONFIG.LINE_ADD_FRIEND_URL}'` }
        ]
      };

      setStatus(config.icon, config.text, 'error');
      setActions(config.buttons);
    }

    // ============================================
    // ä¸»ç¨‹å¼
    // ============================================
    async function main() {
      try {
        // 0. å…ˆå˜—è©¦å¾ URL å–å¾—ä¸¦ä¿å­˜æ¨è–¦ç¢¼ï¼ˆåœ¨ LIFF åˆå§‹åŒ–ä¹‹å‰ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const urlRef = urlParams.get('ref');
        if (urlRef) {
          localStorage.setItem('spark_referral_code', urlRef);
          console.log('å·²ä¿å­˜ ref åˆ° localStorage:', urlRef);
        }

        // 1. åˆå§‹åŒ– LIFFï¼ˆå…ˆåˆå§‹åŒ–æ‰èƒ½æª¢æŸ¥ç™»å…¥ï¼‰
        setStatus('â³', 'æ­£åœ¨é€£æ¥ LINE...', 'loading');
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        // Debug è³‡è¨Š
        setDebug(`URL: ${window.location.href}`);

        // 2. æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        if (!liff.isLoggedIn()) {
          setStatus('ğŸ”', 'éœ€è¦ç™»å…¥ LINE', 'loading');
          // ä¿å­˜ç•¶å‰å®Œæ•´ URL ç”¨æ–¼ç™»å…¥å¾Œè¿”å›
          liff.login({ redirectUri: window.location.href });
          return;
        }

        // 3. å–å¾—æ¨è–¦ç¢¼ï¼ˆç™»å…¥å¾Œï¼‰
        const referralCode = getReferralCode();
        
        setDebug(`URL: ${window.location.href} | ref: ${referralCode}`);
        
        if (!referralCode) {
          setStatus('â“', 'ç¼ºå°‘æ¨è–¦ç¢¼', 'error');
          setActions([
            { label: 'ç›´æ¥åŠ å…¥ Spark', class: 'btn-primary', action: `location.href='${CONFIG.LINE_ADD_FRIEND_URL}'` }
          ]);
          return;
        }

        // 4. å–å¾—ç”¨æˆ¶è³‡æ–™
        const profile = await liff.getProfile();
        const lineUserId = profile.userId;

        // 5. æª¢æŸ¥ç¶²è·¯é€£ç·š
        if (!navigator.onLine) {
          setStatus('ğŸ“¡', 'ç¶²è·¯é€£ç·šä¸­æ–·ï¼Œè«‹æª¢æŸ¥ç¶²è·¯', 'error');
          setActions([
            { label: 'é‡è©¦', class: 'btn-primary', action: 'location.reload()' }
          ]);
          return;
        }

        // 6. å‘¼å« Prebind API
        setStatus('â³', 'æ­£åœ¨è™•ç†æ¨è–¦ç¢¼...', 'loading');
        
        const response = await fetch(CONFIG.PREBIND_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lineUserId: lineUserId,
            referralCode: referralCode
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();

        // 7. æ¸…é™¤ localStorage ä¸­çš„æ¨è–¦ç¢¼
        localStorage.removeItem('spark_referral_code');

        // 8. è™•ç†çµæœ
        if (result.success) {
          const referrerName = result.data?.referrerName || 'å¥½å‹';
          
          // æª¢æŸ¥æ˜¯å¦å·²æ˜¯å¥½å‹
          let isFriend = false;
          try {
            const friendship = await liff.getFriendship();
            isFriend = friendship.friendFlag;
          } catch (e) {
            console.log('ç„¡æ³•å–å¾—å¥½å‹ç‹€æ…‹ï¼Œé è¨­ç‚ºéå¥½å‹');
          }
          
          if (isFriend) {
            // å·²æ˜¯å¥½å‹ â†’ é¡¯ç¤ºæˆåŠŸï¼Œå¯é—œé–‰ LIFF
            setStatus('âœ…', `å·²è¨˜éŒ„ <span class="referrer-name">${referrerName}</span> çš„æ¨è–¦ï¼`, 'success');
            setNote('ğŸ’¡ ç”Ÿæˆç¬¬ä¸€ç¯‡æ–‡æ¡ˆå¾Œï¼Œæ¨è–¦æ­£å¼ç”Ÿæ•ˆå–”ï¼');
            setActions([
              { label: 'é–‹å§‹ä½¿ç”¨ Spark', class: 'btn-primary', action: 'liff.closeWindow()' }
            ]);
          } else {
            // é‚„ä¸æ˜¯å¥½å‹ â†’ å¼•å°åŠ å¥½å‹
            setStatus('âœ…', `å·²è¨˜éŒ„ <span class="referrer-name">${referrerName}</span> çš„æ¨è–¦ï¼`, 'success');
            setNote('ğŸ’¡ åŠ å…¥å¥½å‹ â†’ ç”Ÿæˆç¬¬ä¸€ç¯‡æ–‡æ¡ˆ â†’ æ¨è–¦æ­£å¼ç”Ÿæ•ˆï¼');
            setActions([
              { label: 'åŠ å…¥ Spark å¥½å‹', class: 'btn-primary', action: `location.href='${CONFIG.LINE_ADD_FRIEND_URL}'` }
            ]);
            startCountdown(CONFIG.AUTO_REDIRECT_DELAY / 1000, () => {
              location.href = CONFIG.LINE_ADD_FRIEND_URL;
            });
          }
        } else {
          // è™•ç†éŒ¯èª¤
          handleError(result.error, result.message);
        }

      } catch (error) {
        console.error('LIFF Error:', error);
        setStatus('âŒ', 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        setActions([
          { label: 'é‡è©¦', class: 'btn-secondary', action: 'location.reload()' },
          { label: 'ç›´æ¥åŠ å…¥', class: 'btn-primary', action: `location.href='${CONFIG.LINE_ADD_FRIEND_URL}'` }
        ]);
      }
    }

    // ============================================
    // å•Ÿå‹•
    // ============================================
    main();
  </script>
</body>
</html>
