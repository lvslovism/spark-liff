<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spark</title>
  <style>
    body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #4A90C4 0%, #EA580C 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; }
    .container { text-align: center; color: white; padding: 20px; }
    .logo { font-size: 48px; margin-bottom: 10px; }
    .title { font-size: 24px; font-weight: bold; }
    .hint { font-size: 12px; opacity: 0.8; margin-top: 20px; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="container">
    <div class="logo">✨</div>
    <div class="title">Spark AI</div>
    <div class="hint">正在跳轉...</div>
  </div>

  <script>
    const CONFIG = {
      LIFF_ID: '2008053214-77W1AfvL',
      BIND_API: 'https://astrapath.app.n8n.cloud/webhook/referral-bind',
      OA_CHAT_URL: 'https://line.me/R/oaMessage/@010ndcrh/'
    };

    (async () => {
      const ref = new URLSearchParams(location.search).get('ref');
      
      if (!ref) return location.href = CONFIG.OA_CHAT_URL;

      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: location.href });
          return;
        }

        const profile = await liff.getProfile();
        const { friendFlag } = await liff.getFriendship();

        // 呼叫綁定 API（fire & forget）
        fetch(CONFIG.BIND_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            lineUserId: profile.userId, 
            referralCode: ref 
          })
        });

        if (friendFlag) {
          // 已是好友 → 發送觸發訊息
          await liff.sendMessages([{ 
            type: 'text', 
            text: `REFERRAL_BOUND:${ref}` 
          }]);
          liff.closeWindow();
        } else {
          // 不是好友 → 跳轉 LINE@
          location.href = CONFIG.OA_CHAT_URL;
        }
      } catch (e) {
        console.error(e);
        location.href = CONFIG.OA_CHAT_URL;
      }
    })();
  </script>
</body>
</html>